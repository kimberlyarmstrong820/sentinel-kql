解説と調整の提案（日本語）

異常 IP 判定方法：

上記クエリでは、ユーザーごとの IP 利用頻度の差分（DeltaPct）を用いて異常を判定しています。最も利用されている IP と最も利用が少ない IP の差が大きければ、その少数 IP は異常の候補になります。

Teams 活動の確認：

Teams 関連の操作は OfficeActivity（または Microsoft Graph の監査ログ）に出力されます。環境によっては列名や Workload 名が異なるため、OfficeActivity | take 10 等で実際のフィールドを確認し、teamsEvents の条件を環境に合わせて調整してください。

過去の有効 IP を除外：

notexists(...) 部分で候補 IP が直近 priorValidWindowDays の間に成功サインイン（ResultType == 0）を持つか確認し、持っていれば誤検知として除外します。VPN 利用や出張などで IP が変わる場合は、このウィンドウを長めにする等の調整が有効です。

ノイズとなるエラーコードの除外：

例として 50173（トークン関連のエラーなど）を除外しています。頻繁にノイズを出すエラーコードが他にあれば ignoreErrorCodes に追加してください。

追加で検討できる改善点：

User Agent / Client App 情報を使ったフィルタ、IP の国情報（geo）とユーザーの通常居住地の比較、IP の prevalence（テナント全体での出現頻度）を加えると精度が上がります。

より高度には機械学習ベースの異常検知を使って行動ベースのベースラインを構築する方法もありますが、まずはこのルールで運用試験を行い、閾値を調整するのがおすすめです。
